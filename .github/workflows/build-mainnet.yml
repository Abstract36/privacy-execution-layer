name: Build Mainnet Programs

on:
  workflow_dispatch:
    inputs:
      rust_version:
        description: 'Rust version to use'
        required: false
        default: '1.79.0'
      solana_version:
        description: 'Solana CLI version'
        required: false
        default: 'v1.18.26'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Remove Cargo.lock v4 immediately
        run: |
          rm -f Cargo.lock
          echo "Removed Cargo.lock v4 from repository"
      
      - name: Install Rust ${{ github.event.inputs.rust_version }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ github.event.inputs.rust_version }}
      
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install and verify Solana CLI ${{ github.event.inputs.solana_version }}
        run: |
          # Download Solana CLI directly from GitHub releases
          SOLANA_VERSION="${{ github.event.inputs.solana_version }}"
          SOLANA_VERSION_NUM="${SOLANA_VERSION#v}"
          
          wget -q "https://github.com/solana-labs/solana/releases/download/${SOLANA_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2"
          tar -xjf solana-release-x86_64-unknown-linux-gnu.tar.bz2
          
          # Move to standard location
          mkdir -p "$HOME/.local/share/solana/install/active_release"
          mv solana-release/bin "$HOME/.local/share/solana/install/active_release/"
          
          # Update PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          
          # Verify installation
          solana --version
          cargo build-sbf --version
      

      - name: Build private-pool program
        run: |
          cargo build-sbf --manifest-path=programs/private-pool/Cargo.toml
          ls -lh target/deploy/private_pool.so
      
      - name: Generate program address
        run: |
          echo "## Program Address" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**private_pool:**" >> $GITHUB_STEP_SUMMARY
          solana address -k target/deploy/private_pool-keypair.json >> $GITHUB_STEP_SUMMARY
      
      - name: Upload program binaries
        uses: actions/upload-artifact@v4
        with:
          name: mainnet-programs
          path: |
            target/deploy/private_pool.so
            target/deploy/private_pool-keypair.json
          retention-days: 30
      
      - name: Create build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Programs built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Binary:**" >> $GITHUB_STEP_SUMMARY
          echo "- private_pool.so: $(stat -c%s target/deploy/private_pool.so) bytes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify binaries with \`solana program dump\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to mainnet with \`./scripts/deploy_mainnet.sh\`" >> $GITHUB_STEP_SUMMARY
